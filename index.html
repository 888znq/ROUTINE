<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <link rel="manifest" href="manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="theme-color" content="#000000">
    
    <title>Photo Grid 6x5</title>
    <style>
        /* 1. RESET & LOCK */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body, html {
            margin: 0;
            padding: 0;
            width: 100vw;
            height: 100vh;
            background-color: #000000; 
            overflow: hidden; 
            overscroll-behavior: none; 
            user-select: none;
            font-family: Verdana, Geneva, Tahoma, sans-serif;
        }

        /* 2. LAYOUT (Exact 6x5) */
        .grid-container {
            width: 100%;
            height: 100%;
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            grid-template-rows: repeat(5, 3fr 2fr);
            padding: 5vmin 5vmin 12vmin 5vmin; 
            gap: 2vmin;
        }

        /* 3. IMAGE BOX (Replaces Text Box) */
        .status-box {
            position: relative;
            border: 2px solid #FF0000;
            background-color: #000000; 
            border-radius: 8px;
            width: 100%;
            height: 100%;
            cursor: pointer;
            overflow: hidden;
            
            /* Image Styling */
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            
            transition: border-color 0.1s;
        }

        /* PLUS SIGN (+) */
        .status-box::after {
            content: "+";
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            color: #444; 
            font-size: 24px;
            font-weight: bold;
            pointer-events: none; 
        }

        /* Hide Plus when image exists */
        .status-box.has-image::after { display: none; }

        /* ACTIVE STATE (Green) */
        .status-box.active { border-color: #00FF00; }

        /* EDIT MODE (Yellow Pulse) */
        .status-box.selected-edit {
            border-color: #FFFF00 !important;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(255, 255, 0, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(255, 255, 0, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 255, 0, 0); }
        }

        /* Hidden File Input */
        .file-input { display: none; }

        /* 4. TOGGLE CONTAINER */
        .toggle-cell {
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100%;
            height: 100%;
        }

        /* 5. THE TOGGLE BUTTON */
        .circle-btn {
            height: 80%; 
            aspect-ratio: 1 / 1; 
            border-radius: 50%;
            background-color: #FF0000;
            border: 2px solid #000000; 
            cursor: pointer;
        }

        .circle-btn.active { background-color: #00FF00; }

        /* 6. RESET BUTTON */
        #reset-btn {
            position: fixed;
            bottom: 3vh;
            left: 50%;
            transform: translateX(-50%);
            width: 60px; /* JS updates this */
            height: 60px;
            border-radius: 50%;
            background-color: #FF0000;
            border: 2px solid #000000; 
            cursor: pointer;
            z-index: 1000;
        }

        #reset-btn:active { background-color: #990000; }

    </style>
</head>
<body>

    <div class="grid-container" id="grid"></div>
    <div id="reset-btn"></div>

    <script>
        const grid = document.getElementById('grid');
        const resetBtn = document.getElementById('reset-btn');
        const cols = 6;
        const units = 5;

        // --- SOUND ENGINE ---
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();

        function playSound(type) {
            if (audioContext.state === 'suspended') audioContext.resume();
            
            const osc = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            osc.connect(gainNode);
            gainNode.connect(audioContext.destination);

            const now = audioContext.currentTime;

            if (type === 'on') { 
                osc.type = 'sine';
                osc.frequency.setValueAtTime(800, now);
                osc.frequency.exponentialRampToValueAtTime(300, now + 0.1);
            } else if (type === 'off') { 
                osc.type = 'triangle';
                osc.frequency.setValueAtTime(300, now);
                osc.frequency.exponentialRampToValueAtTime(100, now + 0.1);
            } else if (type === 'reset') { 
                osc.type = 'sawtooth';
                osc.frequency.setValueAtTime(150, now);
                osc.frequency.exponentialRampToValueAtTime(10, now + 0.3);
                gainNode.gain.setValueAtTime(0.2, now);
                gainNode.gain.linearRampToValueAtTime(0, now + 0.3);
                osc.start();
                osc.stop(now + 0.3);
                return;
            } else if (type === 'select') { 
                osc.type = 'square';
                osc.frequency.setValueAtTime(400, now);
                osc.frequency.exponentialRampToValueAtTime(600, now + 0.1);
            } else if (type === 'delete') { 
                osc.type = 'sawtooth';
                osc.frequency.setValueAtTime(100, now);
                osc.frequency.exponentialRampToValueAtTime(10, now + 0.2);
            } else if (type === 'swap') { 
                osc.type = 'sine';
                osc.frequency.setValueAtTime(600, now);
                osc.frequency.linearRampToValueAtTime(400, now + 0.1);
            }

            gainNode.gain.setValueAtTime(0.1, now);
            gainNode.gain.exponentialRampToValueAtTime(0.001, now + 0.1);

            osc.start();
            osc.stop(now + 0.1); 
        }

        // --- IMAGE RESIZER ---
        function resizeImage(file, callback) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image();
                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    const maxSize = 150; 
                    let width = img.width;
                    let height = img.height;
                    
                    if (width > height) {
                        if (width > maxSize) { height *= maxSize / width; width = maxSize; }
                    } else {
                        if (height > maxSize) { width *= maxSize / height; height = maxSize; }
                    }
                    canvas.width = width;
                    canvas.height = height;
                    ctx.drawImage(img, 0, 0, width, height);
                    callback(canvas.toDataURL('image/jpeg', 0.7));
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        // --- GRID LOGIC ---
        let savedState = JSON.parse(localStorage.getItem('gridState')) || [];
        // Images stored here instead of text labels
        let savedImages = JSON.parse(localStorage.getItem('gridImages')) || [];

        // Edit Mode Vars
        let selectedIndex = null;
        let longPressTimer = null;
        let isLongPress = false;

        let allPairs = []; 
        let itemIndex = 0; 
        let firstButton = null;

        for (let u = 0; u < units; u++) {
            let currentBoxes = [];

            // 1. Boxes (Images)
            for (let c = 0; c < cols; c++) {
                const currentIndex = itemIndex + c;
                const box = document.createElement('div');
                box.classList.add('status-box');
                
                // HIDDEN INPUT
                const fileInput = document.createElement('input');
                fileInput.type = 'file';
                fileInput.accept = 'image/*';
                fileInput.classList.add('file-input');

                // LOAD DATA
                if (savedImages[currentIndex]) {
                    box.style.backgroundImage = `url(${savedImages[currentIndex]})`;
                    box.classList.add('has-image');
                }
                if (savedState[currentIndex] === true) box.classList.add('active');

                // --- INTERACTION ---
                
                // 1. Long Press Detect
                const startHandler = (e) => {
                    isLongPress = false;
                    longPressTimer = setTimeout(() => {
                        isLongPress = true;
                        handleSelection(currentIndex);
                        if(e.cancelable && e.preventDefault) e.preventDefault(); 
                    }, 500);
                };
                const endHandler = () => clearTimeout(longPressTimer);

                box.addEventListener('mousedown', startHandler);
                box.addEventListener('touchstart', startHandler, {passive: false});
                box.addEventListener('mouseup', endHandler);
                box.addEventListener('touchend', endHandler);

                // 2. Click Handler (Upload or Swap/Delete)
                box.onclick = function() {
                    if (isLongPress) return;

                    // EDIT MODE
                    if (selectedIndex !== null) {
                        if (selectedIndex === currentIndex) deleteItem(currentIndex);
                        else swapItems(selectedIndex, currentIndex);
                        return;
                    }

                    // NORMAL MODE -> UPLOAD
                    fileInput.click();
                };

                // 3. File Upload Logic
                fileInput.onchange = function(e) {
                    if (this.files && this.files[0]) {
                        resizeImage(this.files[0], function(base64Image) {
                            savedImages[currentIndex] = base64Image;
                            updateBoxUI(currentIndex);
                            saveAllData();
                        });
                    }
                    this.value = '';
                };

                box.appendChild(fileInput);
                grid.appendChild(box);
                currentBoxes.push(box);
            }

            // 2. Buttons
            for (let c = 0; c < cols; c++) {
                const cell = document.createElement('div');
                cell.classList.add('toggle-cell');
                
                const btn = document.createElement('div');
                btn.classList.add('circle-btn');
                
                if (!firstButton) firstButton = btn;

                const currentId = itemIndex; 
                const linkedBox = currentBoxes[c]; 

                if (savedState[currentId] === true) btn.classList.add('active');

                // Button Click -> Toggle Light Only
                btn.onclick = function() {
                    const isCurrentlyActive = btn.classList.contains('active');
                    const newState = !isCurrentlyActive; 

                    if (newState) {
                        btn.classList.add('active');
                        linkedBox.classList.add('active');
                        playSound('on');
                    } else {
                        btn.classList.remove('active');
                        linkedBox.classList.remove('active');
                        playSound('off');
                    }
                    savedState[currentId] = newState;
                    localStorage.setItem('gridState', JSON.stringify(savedState));
                };

                allPairs.push({ btn: btn, box: linkedBox });
                cell.appendChild(btn);
                grid.appendChild(cell);
                itemIndex++; 
            }
        }

        // --- HELPER FUNCTIONS ---
        function handleSelection(index) {
            if (selectedIndex !== null) {
                allPairs[selectedIndex].box.classList.remove('selected-edit');
            }
            selectedIndex = index;
            allPairs[index].box.classList.add('selected-edit');
            playSound('select');
            setTimeout(() => { if (selectedIndex === index) clearSelection(); }, 5000);
        }

        function clearSelection() {
            if (selectedIndex !== null) {
                allPairs[selectedIndex].box.classList.remove('selected-edit');
                selectedIndex = null;
            }
        }

        function deleteItem(index) {
            savedImages[index] = null;
            updateBoxUI(index);
            saveAllData();
            playSound('delete');
            clearSelection();
        }

        function swapItems(fromIndex, toIndex) {
            // Swap Images
            const tempImg = savedImages[fromIndex];
            savedImages[fromIndex] = savedImages[toIndex];
            savedImages[toIndex] = tempImg;

            // Swap Lights
            const tempState = savedState[fromIndex];
            savedState[fromIndex] = savedState[toIndex];
            savedState[toIndex] = tempState;

            updateBoxUI(fromIndex);
            updateBoxUI(toIndex);
            updateLightUI(fromIndex);
            updateLightUI(toIndex);

            saveAllData();
            playSound('swap');
            clearSelection();
        }

        function updateBoxUI(index) {
            const box = allPairs[index].box;
            const imgData = savedImages[index];
            if (imgData) {
                box.style.backgroundImage = `url(${imgData})`;
                box.classList.add('has-image');
            } else {
                box.style.backgroundImage = '';
                box.classList.remove('has-image');
            }
        }

        function updateLightUI(index) {
            const isActive = savedState[index];
            const pair = allPairs[index];
            if (isActive) {
                pair.box.classList.add('active');
                pair.btn.classList.add('active');
            } else {
                pair.box.classList.remove('active');
                pair.btn.classList.remove('active');
            }
        }

        function saveAllData() {
            try {
                localStorage.setItem('gridImages', JSON.stringify(savedImages));
                localStorage.setItem('gridState', JSON.stringify(savedState));
            } catch (e) {
                alert("Storage full! Delete some images.");
            }
        }

        // --- SIZE SYNC ENGINE ---
        function syncResetButtonSize() {
            if (firstButton) {
                const width = firstButton.offsetWidth;
                const height = firstButton.offsetHeight;
                resetBtn.style.width = width + 'px';
                resetBtn.style.height = height + 'px';
            }
        }
        syncResetButtonSize();
        window.addEventListener('resize', syncResetButtonSize);

        // --- RESET LOGIC ---
        resetBtn.onclick = function() {
            playSound('reset');
            allPairs.forEach(pair => {
                pair.btn.classList.remove('active');
                pair.box.classList.remove('active');
            });
            savedState = [];
            localStorage.setItem('gridState', JSON.stringify(savedState));
        };

    </script>
</body>
</html>